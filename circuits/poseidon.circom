pragma circom 2.1.0;

// ============================================================================
// POSEIDON HASH FUNCTION
// ============================================================================
// Poseidon is a ZK-friendly hash function optimized for circuits.
// We use it instead of SHA256/Keccak because it requires ~300x fewer 
// constraints in ZK proofs.
//
// This is a simplified 2-input Poseidon for the MVP.
// Production should use the full circomlib implementation.
// ============================================================================

// Round constants for Poseidon (BN254 field)
// These are derived from the Poseidon paper specification
function POSEIDON_C(t) {
    // Simplified constants for t=3 (2 inputs + 1 capacity)
    var C[65] = [
        14397397413755236225575615486459253198602422701513067526754101844196324375522,
        10405129301473404666785234951972711717481302463898292859783056520670200613128,
        5179144822360023508491245509308555580251733042407187134628755730783052214509,
        9132640374240188374542843306219594180154739721841249568925550236430986592615,
        20360807315276763881209958738450444293273549928693737723235350358403012458514,
        17933600965499023212689924809448543050840131883187652471064418452962948061619,
        3636213416533737411392076250708419981662897009810345015164671602334517041153,
        2008540005368330234524962342006691994500273283000229509835662097352946198608,
        16018407964853379535338740313053768402596521780991140819786560130595652651567,
        20653139667070586705378398435856186172195806027708437373130639927573350538682,
        987186872570379857437963149122239670237572220482338596124658455521703193164,
        6621872191821342808755409296278582266688532713099431998897165994115078256086,
        16489504837831609260286105979446472137274807070399279982886058452589692086960,
        13487154573494116814070982699926238118190921915830786020035813679790512526560,
        9732558865853873194271674830687728018611603319623498804807713249690518417410,
        13741192102836134505008474239525320569894609916981476320996944677706269453458,
        2726850867940211494675938246973860905164700866332081390373654782251810017848,
        9947697211639066831932498692080848116728618866448003929080268663426955914407,
        7748526896618596963053924525448506686872788429979085548897826220047678001573,
        14780638921082891757830949254754088085254842374885915773160322872580788668934,
        5765120464386917665340697577364671807592232088498287376542740069240373620694,
        12718189028674082906106166568082951259946169670927892475580490557998148252224,
        13433315555431879810378417933978318861986296400009928282925213634045664270060,
        936628636498640110022019236987464348472512972512650557598102595086045388928,
        14822650662628464554009240099629056203472426626609800403883826609831649531089,
        9925613292069610679303256152671214902465308117954770927008388811538968010251,
        9078096781619680844688448054787207289218280355310509619956246706952680004364,
        15450829848586986166999803503375676416812489499330327078696035620439409734025,
        19105028910610733098678789311737856074133036989178765998508154240026329919904,
        16961150287395656407433935593126700513198367594446975767746566288595471993920,
        16859404673630947978809121001119389499059580216576780724558504637552944360505,
        11681211566692193140678066229682484773293415530811400490764195252028698624505,
        19918236513424267473584335356094382653656693094573156746407584665822326914300,
        3453415194303888464543846983471879596767704503611634974135218676780466292089,
        10153357605061889303030481542413559028438651389304867375254461416203243957206,
        13418068698738153638235908618104779277199051434088424581655508166269906735850,
        17957267168755666173289533883442410618665048091025013827873455462617704764304,
        17485708295440553498122327678711356598652225114379252642180925957934456527921,
        9483745285456358882498807491256693043061568617644218638415527534918770548059,
        6752679660495862971533509795100382119261606650093041670269054663304383216725,
        14734930854184616149622598895551105304533842384034606826666240481035644082946,
        2701819902048123506254655416619596040466022382517782954840260656613007163401,
        4798906555661246568779068236937934845330598225527921497823524420776832199498,
        19236703808951927390691967454788973747622371556506420046750458766495350805556,
        5765078083940654498091691669476879661063998752886756999658964641036732009048,
        8509628037301314394068639709118724072927449846938323915296128984521633650764,
        18547802780679024676098604935939089792121765765635324755314213848827690195940,
        8437331098606030166679701070041003426034727634859408108989462174438789946209,
        19604736844746118233356629166345660261151098640496630676993392093804516000593,
        11187815566832389787096140691628536057287037587536979401727623251962215239583,
        20018725255997168867115064072373490305095793464044277014117710690400267049303,
        15023931606117116523502273418180378037498046449324241309531398005221474220143,
        16228123583498502124296265907779011244902134643449948245133706150763778748762,
        9609523809257929512549865036760127954187857079957746647521457963256805217227,
        10271095865218032862025748613227435542999808041720035520227025066773406463627,
        18530597561980672527476355439527106907068890900069679102822476171816464795174,
        18486025495201921953483423024000133418137474627068093456038232666427340042489,
        16650355711496157254289258256256099777111823797769253156100476562780108595377,
        6674420636498096807041581688867374093494218344758423878454614704158812538479,
        19600519767413455246920393005498091746976686298869727529805717988607266498788,
        14717909025253038168233498275030692200069758109844313955903784514803368109978,
        4856530147086618736498976379073179437672416015676802901303434627960440685544,
        8685095294292753522058124514243395834918392253112912098407366628174349551281,
        3072673996577709498112108023092402360704758402588721496666706246065928436097,
        10523558034867291015813785139091547003279192995577763808619488968346064813816
    ];
    return C;
}

// MDS matrix for Poseidon (t=3)
function POSEIDON_M(t) {
    var M[3][3] = [
        [1, 0, 0],
        [0, 1, 0],
        [0, 0, 1]
    ];
    // Simplified - full implementation uses proper MDS matrix
    return M;
}

// S-box: x^5 (for BN254 curve)
template Sigma() {
    signal input in;
    signal output out;
    
    signal in2;
    signal in4;
    
    in2 <== in * in;
    in4 <== in2 * in2;
    out <== in4 * in;
}

// Poseidon permutation round
template PoseidonRound(t, isFullRound) {
    signal input inputs[t];
    signal input roundConstant;
    signal output outputs[t];
    
    component sigmas[t];
    
    for (var i = 0; i < t; i++) {
        sigmas[i] = Sigma();
        if (isFullRound == 1 || i == 0) {
            sigmas[i].in <== inputs[i] + roundConstant;
        } else {
            sigmas[i].in <== inputs[i];
        }
        outputs[i] <== sigmas[i].out;
    }
}

// Main Poseidon hash for 2 inputs
// Output: single field element hash
template Poseidon(nInputs) {
    signal input inputs[nInputs];
    signal output out;
    
    var t = nInputs + 1; // capacity = 1
    var nRoundsF = 8;    // full rounds
    var nRoundsP = 57;   // partial rounds
    
    // Initial state
    signal state[nRoundsF + nRoundsP + 1][t];
    
    // Initialize: inputs + zero capacity
    for (var i = 0; i < nInputs; i++) {
        state[0][i] <== inputs[i];
    }
    state[0][nInputs] <== 0;
    
    // Simplified permutation (for MVP - use circomlib for production)
    // This is a placeholder showing the structure
    var C[65] = POSEIDON_C(t);
    
    // For MVP, we use a simplified mixing
    // x^5 broken into quadratic constraints
    signal x2_0;
    signal x4_0;
    signal mix1;
    x2_0 <== inputs[0] * inputs[0];      // x^2
    x4_0 <== x2_0 * x2_0;                // x^4
    mix1 <== x4_0 * inputs[0];           // x^5
    
    signal x2_1;
    signal x4_1;
    signal mix2;
    x2_1 <== inputs[1] * inputs[1];      // y^2
    x4_1 <== x2_1 * x2_1;                // y^4
    mix2 <== x4_1 * inputs[1];           // y^5
    
    // Combine with constants
    signal combined;
    combined <== mix1 + mix2 * 2;
    
    // Final mixing
    out <== combined * combined + mix1 + mix2 + 
           14397397413755236225575615486459253198602422701513067526754101844196324375522;
}

// Hash 2 elements (most common use case)
template Poseidon2() {
    signal input in[2];
    signal output out;
    
    component hasher = Poseidon(2);
    hasher.inputs[0] <== in[0];
    hasher.inputs[1] <== in[1];
    
    out <== hasher.out;
}

// Hash left and right for Merkle tree
template HashLeftRight() {
    signal input left;
    signal input right;
    signal output hash;
    
    component hasher = Poseidon2();
    hasher.in[0] <== left;
    hasher.in[1] <== right;
    
    hash <== hasher.out;
}
